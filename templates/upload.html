<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Images</title>
    <!-- Latest Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="text-center mb-4">Upload and Convert Images</h3>
                    <div id="alert" class="alert d-none" role="alert"></div>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <!-- CSRF Token -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="directory" class="form-label">Directory Name</label>
                            <input type="text" class="form-control" name="directory" id="directory" required>
                            <small class="form-text text-muted">Provide a name for the directory to save your PDF.</small>
                        </div>
                        <div class="mb-3">
                            <label for="photo" class="form-label">Upload Files</label>
                            <input type="file" class="form-control" name="photo" id="photo" multiple>
                            <small class="form-text text-muted">Select one or more images to convert to PDF.</small>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Upload and Convert</button>
                        </div>
                        <div class="mt-3">
                        <div class="mt-3">
                        <div id="progressWrapper" class="d-none"> <!-- Keep the 'd-none' class here -->
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                            </div>
                            <p id="progressText" class="text-center mt-2">Uploading...</p>
                        </div>
                    </div>
                    </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<!-- AJAX to submit form without reloading the page -->
<script>
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        formData.append("csrf_token", document.querySelector("[name=csrf_token]").value);

        const progressWrapper = document.getElementById('progressWrapper');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        // Display the progress bar
        progressWrapper.classList.remove('d-none');

        fetch('/upload', {
            method: 'POST',
            body: formData,
            onUploadProgress: function(progressEvent) {
                const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                progressBar.style.width = percentCompleted + '%';
                progressBar.setAttribute('aria-valuenow', percentCompleted);
                if (percentCompleted === 100) {
                    progressText.textContent = 'Processing...';
                }
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const alertBox = document.getElementById('alert');
                alertBox.className = 'alert alert-success';
                alertBox.textContent = 'Successfully uploaded and converted!';
                alertBox.classList.remove('d-none');
                window.location.href = `/${data.path}`;
            } else {
                const alertBox = document.getElementById('alert');
                alertBox.className = 'alert alert-danger';
                alertBox.textContent = 'Error: ' + data.error;
                alertBox.classList.remove('d-none');
            }
            progressWrapper.classList.add('d-none');  // Hide the progress bar
        })
        .catch(error => {
            console.error('Error uploading and converting images:', error);
        });
    });
</script>
</body>
</html>
